#!/usr/bin/env python3
"""
知识库内容填充脚本
为流体动力学模拟系统添加基础知识内容
"""

import sys
import os
import json
from sqlalchemy.orm import Session

# 添加项目根目录到Python路径
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.database.database import SessionLocal, engine
from src.models.models import KnowledgeItem, Base

# 确保数据库表存在
Base.metadata.create_all(bind=engine)

# 知识条目数据
knowledge_items = [
    # 流体力学基础
    {
        "title": "流体力学的基本概念",
        "category": "fluid_basics",
        "content": """
# 流体力学的基本概念

流体力学是研究流体（液体和气体）运动及其与固体相互作用的科学。

## 基本定义

- **流体**：能够连续变形并且服从剪切应力的物质
- **不可压缩流体**：密度保持恒定的流体
- **可压缩流体**：密度可以变化的流体（如气体）
- **粘性**：流体内部的摩擦力，反映流体抵抗流动的能力
- **密度**：单位体积内的质量

## 基本参数

- **雷诺数 (Re)**：惯性力与粘性力的比值，决定流动的特性
- **马赫数 (Ma)**：流速与声速的比值，用于可压缩流动
- **弗劳德数 (Fr)**：惯性力与重力的比值，用于自由表面流动

## 基本方程

- **连续性方程**：质量守恒
- **动量方程**：牛顿第二定律应用于流体
- **能量方程**：能量守恒

这些基本概念构成了流体力学分析和模拟的基础框架。
        """,
        "tags": "流体力学,基本概念,雷诺数,粘性,密度"
    },
    {
        "title": "流体的物理性质",
        "category": "fluid_basics",
        "content": """
# 流体的物理性质

流体的物理性质对其流动行为有着决定性的影响。

## 密度 (ρ)

密度是单位体积内的质量，单位为kg/m³。
- 水的密度约为1000 kg/m³
- 空气在标准条件下的密度约为1.225 kg/m³

## 粘度 (μ)

粘度描述了流体的"黏稠度"，反映了流体抵抗流动的内部摩擦力。
- 动力粘度(μ)：单位为Pa·s
- 运动粘度(ν)：ν = μ/ρ，单位为m²/s

## 压缩性

流体在压力作用下体积变化的能力。
- 液体通常被视为不可压缩的
- 气体是可压缩的，遵循理想气体定律 PV = nRT

## 表面张力

液体表面的收缩趋势，导致液体表面形成一层"膜"。
- 单位为N/m
- 导致毛细现象、液滴形成等

## 热物理性质

- 比热容：单位质量流体温度升高1度所需的热量
- 热传导系数：流体传导热量的能力

这些物理性质在流体动力学模拟中需要准确指定，以获得正确的模拟结果。
        """,
        "tags": "流体物理性质,密度,粘度,压缩性,表面张力"
    },
    
    # Navier-Stokes方程
    {
        "title": "Navier-Stokes方程详解",
        "category": "navier_stokes",
        "content": """
# Navier-Stokes方程详解

Navier-Stokes方程是描述粘性流体运动的非线性偏微分方程组，由法国工程师Claude-Louis Navier和英国物理学家George Gabriel Stokes分别于1822年和1845年提出。

## 方程形式

对于不可压缩流体，Navier-Stokes方程可以表示为：

### 连续性方程（质量守恒）
∇·u = 0

### 动量方程（牛顿第二定律）
ρ(∂u/∂t + u·∇u) = -∇p + μ∇²u + ρg

其中：
- u 是速度矢量
- p 是压力
- ρ 是密度
- μ 是动力粘度
- g 是重力加速度

## 方程特点

1. **非线性性**：对流项 u·∇u 是非线性的，导致方程难以求解
2. **耦合性**：速度和压力相互耦合
3. **多尺度性**：流动可能包含多个时空尺度

## 求解挑战

Navier-Stokes方程的求解是计算流体力学的核心挑战：
- 解析解仅适用于极少数简单情况
- 数值求解需要离散化方程并应用迭代算法
- 高雷诺数流动需要极高的网格分辨率

## 常用求解方法

1. **有限差分法**：使用泰勒展开近似导数
2. **有限体积法**：基于积分形式的守恒定律
3. **有限元法**：使用基函数近似解
4. **谱方法**：使用傅里叶级数等正交函数

Navier-Stokes方程是流体动力学模拟的基础，正确求解这些方程是获得准确模拟结果的关键。
        """,
        "tags": "Navier-Stokes,偏微分方程,流体动力学,数值求解"
    },
    
    # 圆柱体绕流
    {
        "title": "圆柱体绕流的物理原理",
        "category": "cylinder_flow",
        "content": """
# 圆柱体绕流的物理原理

圆柱体绕流是流体动力学中的经典问题，也是研究流体与物体相互作用的重要案例。

## 流动特征

圆柱体绕流的特征高度依赖于雷诺数(Re)：

1. **低雷诺数 (Re < 5)**：
   - 流线对称
   - 无分离
   - 斯托克斯流动

2. **中等雷诺数 (5 < Re < 40)**：
   - 流线不对称
   - 出现稳定的尾部涡对
   - 流动仍然稳定

3. **高雷诺数 (40 < Re < 150)**：
   - 开始周期性脱落涡
   - 形成卡门涡街
   - 流动变为非稳态

4. **更高雷诺数 (Re > 150)**：
   - 湍流尾流
   - 三维效应显著
   - 流动高度不稳定

## 物理现象

### 压力分布

圆柱体表面的压力分布呈现以下特点：
- 前驻点压力最高
- 侧面压力最低
- 后部压力回升但低于前部

### 阻力系数

圆柱体受到两种阻力：
1. **摩擦阻力**：由粘性引起
2. **压差阻力**：由压力分布不均引起

总阻力系数随雷诺数变化：
- Re < 1: Cd ∝ 1/Re
- Re ≈ 1000: Cd ≈ 1.0
- Re > 10⁵: Cd ≈ 0.2 (临界雷诺数后)

## 工程应用

圆柱体绕流研究对以下领域具有重要意义：
- 桥梁立柱设计
- 高层建筑风荷载分析
- 热交换器设计
- 海洋平台结构设计

在模拟中，正确设置入口速度、圆柱直径和流体粘度对获得准确结果至关重要。
        """,
        "tags": "圆柱体绕流,雷诺数,阻力系数,流动分离,卡门涡街"
    },
    
    # 卡门涡街
    {
        "title": "卡门涡街形成机制与特性",
        "category": "karman_vortex",
        "content": """
# 卡门涡街形成机制与特性

卡门涡街是流体经过钝体（如圆柱体）后形成的交替脱落的涡列，以匈牙利-美国物理学家西奥多·冯·卡门命名。

## 形成机制

卡门涡街的形成可分为以下几个步骤：

1. **边界层分离**：
   - 流体在圆柱体表面形成边界层
   - 由于逆压梯度，边界层在圆柱体后部分离

2. **剪切层不稳定性**：
   - 分离的剪切层变得不稳定
   - 小扰动被放大

3. **交替涡脱落**：
   - 一侧形成涡旋并脱落
   - 导致另一侧产生反向涡旋
   - 形成交替脱落的涡列

## 斯特劳哈尔数

卡门涡街的脱落频率可以用无量纲斯特劳哈尔数(St)表示：

St = f·D/U

其中：
- f 是涡脱落频率
- D 是物体特征尺寸（如圆柱直径）
- U 是来流速度

对于圆柱体，在较宽的雷诺数范围内，St ≈ 0.2。

## 影响因素

卡门涡街的形成和特性受多种因素影响：

1. **雷诺数**：
   - Re < 40: 无涡脱落
   - 40 < Re < 150: 二维层流涡街
   - 150 < Re < 300: 三维效应开始显现
   - Re > 300: 湍流涡街

2. **物体形状**：
   - 圆柱体、方柱等钝体易形成涡街
   - 流线型物体可减弱或消除涡街

3. **流动约束**：
   - 近壁效应
   - 多物体干扰

## 工程意义

卡门涡街在工程中有重要意义：

1. **结构振动**：
   - 当涡脱落频率接近结构自然频率时，可能导致共振
   - 导致桥梁、烟囱等结构失效

2. **声音产生**：
   - 风吹电线产生的"呜呜"声
   - 埃奥琉斯竖琴原理

3. **热交换增强**：
   - 涡街可增强换热
   - 应用于换热器设计

在模拟卡门涡街时，需要足够长的模拟时间以观察完整的周期性行为，并使用适当的时间步长捕捉涡脱落动态过程。
        """,
        "tags": "卡门涡街,涡脱落,斯特劳哈尔数,流动不稳定性,结构振动"
    },
    
    # 通道流
    {
        "title": "通道流特性分析",
        "category": "channel_flow",
        "content": """
# 通道流特性分析

通道流是指流体在两平行壁面之间的流动，是流体力学中的基础问题之一，也是验证数值方法的重要基准案例。

## 层流通道流

### 泊肃叶流动

完全发展的层流通道流被称为泊肃叶流动，具有以下特点：

1. **速度分布**：
   - 抛物线形状: u(y) = u_max [1 - (y/h)²]
   - 中心速度最大，壁面速度为零

2. **压力梯度**：
   - 线性压降: dp/dx = -12μU_avg/h²
   - 其中μ是流体粘度，U_avg是平均速度，h是半通道高度

3. **剪切应力分布**：
   - 线性变化
   - 壁面剪切应力最大，中心剪切应力为零

## 湍流通道流

当雷诺数增大时，通道流转变为湍流，特点包括：

1. **速度分布**：
   - 更加平坦的核心区
   - 近壁区有陡峭的速度梯度
   - 可用对数律描述: u⁺ = (1/κ)ln(y⁺) + B

2. **湍流结构**：
   - 近壁区：低速条纹和准流向涡
   - 缓冲区：发卡涡和湍流爆发
   - 外层：大尺度运动和湍流团块

3. **雷诺应力**：
   - 反映湍流脉动的强度
   - 对动量传递有重要贡献

## 入口效应

通道入口处的流动尚未完全发展，表现为：

1. **入口长度**：
   - 层流: L_e ≈ 0.05·Re·D_h
   - 湍流: L_e ≈ 10·D_h
   - 其中D_h是水力直径

2. **速度分布演化**：
   - 入口处接近均匀分布
   - 逐渐发展为抛物线或湍流分布

## 热传递特性

通道流中的热传递具有以下特点：

1. **层流热传递**：
   - 努塞尔数: Nu = 7.54（恒壁温）或 4.36（恒热流）
   - 温度分布也呈抛物线形

2. **湍流热传递**：
   - 热传递显著增强
   - 努塞尔数随雷诺数和普朗特数变化

在模拟通道流时，正确设置入口条件、壁面条件和足够的通道长度对获得准确结果至关重要。
        """,
        "tags": "通道流,泊肃叶流动,层流,湍流,速度分布,入口效应"
    },
    
    # 盖驱动腔流
    {
        "title": "盖驱动腔流动力学特性",
        "category": "lid_driven_cavity",
        "content": """
# 盖驱动腔流动力学特性

盖驱动腔流是指封闭方腔内，由于顶部壁面以恒定速度移动而产生的流动。这是计算流体力学中最常用的基准问题之一，用于验证数值算法的准确性和稳定性。

## 流动结构

盖驱动腔流的流动结构随雷诺数变化显著：

1. **低雷诺数 (Re < 1000)**：
   - 单一主涡居中
   - 腔体角落有小的二次涡
   - 流动稳定且对称

2. **中等雷诺数 (1000 < Re < 10000)**：
   - 主涡中心向右上方移动
   - 角落二次涡增大
   - 出现更多高阶涡结构

3. **高雷诺数 (Re > 10000)**：
   - 流动变得不稳定
   - 可能出现周期性行为
   - 三维效应显著

## 涡结构

盖驱动腔中的典型涡结构包括：

1. **主涡**：
   - 占据腔体大部分区域
   - 由顶部移动壁面直接驱动

2. **角落涡**：
   - BR涡：右下角
   - BL涡：左下角
   - TR涡：右上角（高雷诺数时）

3. **高阶涡**：
   - 在主涡和角落涡之间可能出现
   - 旋转方向交替变化

## 速度分布

盖驱动腔内的速度分布具有以下特点：

1. **水平中心线**：
   - u分量从正值变为负值
   - 曲线陡度随雷诺数增加

2. **垂直中心线**：
   - v分量呈S形分布
   - 最大值和最小值随雷诺数增大

## 数值模拟考虑

在模拟盖驱动腔流时需要注意：

1. **网格分辨率**：
   - 高雷诺数需要更细的网格
   - 角落区域需要网格加密

2. **离散格式**：
   - 高阶格式可减少数值扩散
   - 对流项需要特别处理

3. **求解策略**：
   - 低雷诺数可用直接求解
   - 高雷诺数需要迭代求解
   - 可能需要亚松弛以确保收敛

盖驱动腔流是验证新开发的数值方法和代码的理想测试案例，因为它结构简单但流动复杂，且有大量参考数据可供比较。
        """,
        "tags": "盖驱动腔流,基准问题,涡结构,数值模拟,雷诺数"
    },
    
    # 流体可视化
    {
        "title": "流体动力学可视化技术",
        "category": "visualization",
        "content": """
# 流体动力学可视化技术

流体动力学可视化是理解复杂流动现象的重要工具，既适用于实验研究，也适用于数值模拟结果的分析。

## 实验可视化技术

### 流线显示技术

1. **染色法**：
   - 向流体中注入着色剂
   - 直观显示流体运动路径
   - 适用于低速流动

2. **烟线法**：
   - 在气流中释放烟雾
   - 可视化空气流动路径
   - 广泛用于风洞试验

3. **氢气泡法**：
   - 通过电解水产生氢气泡
   - 跟踪水流运动
   - 可用于测量速度分布

### 粒子图像测速法 (PIV)

1. **工作原理**：
   - 向流体中添加示踪粒子
   - 用激光照明截面
   - 高速相机捕捉粒子运动
   - 通过图像处理计算速度场

2. **优势**：
   - 获取整个流场的速度分布
   - 非侵入式测量
   - 高时空分辨率

### 其他实验技术

1. **纹影法**：利用折射率变化可视化密度梯度
2. **液晶温度显示**：显示表面温度分布
3. **激光诱导荧光(LIF)**：测量浓度分布

## 数值模拟可视化

### 标量场可视化

1. **云图**：
   - 使用颜色映射显示标量值
   - 适用于压力、温度等场
   - 可在任意截面上显示

2. **等值线/等值面**：
   - 连接相同数值的点/面
   - 清晰显示梯度变化区域
   - 识别特征结构

### 矢量场可视化

1. **箭头图**：
   - 直接显示速度矢量
   - 箭头长度和方向表示速度大小和方向
   - 适合低密度区域

2. **流线/流迹线**：
   - 显示流体粒子运动路径
   - 识别涡结构和分离区
   - 可使用颜色表示其他物理量

3. **流带**：
   - 三维流线的带状表示
   - 可显示局部旋转
   - 更直观地展示3D流动

### 特征提取

1. **涡识别**：
   - Q准则、λ₂准则等方法
   - 识别和可视化涡结构

2. **临界点分析**：
   - 识别驻点、鞍点等特征
   - 理解流动拓扑结构

## 交互式可视化

现代可视化技术支持交互式探索：

1. **实时旋转和缩放**
2. **动态切片和过滤**
3. **参数动态调整**
4. **虚拟现实(VR)沉浸式体验**

有效的流体可视化不仅是美观的图像，更是理解复杂流动物理机制的强大工具。
        """,
        "tags": "流体可视化,PIV,流线,涡识别,数据可视化,三维可视化"
    }
]

def populate_knowledge_base():
    """向数据库中添加知识条目"""
    db = SessionLocal()
    try:
        print("开始添加知识库内容...")
        
        # 检查是否已有内容
        existing_count = db.query(KnowledgeItem).count()
        if existing_count > 0:
            print(f"知识库中已有 {existing_count} 条内容，跳过添加。")
            print("如需重新添加，请先清空知识库表。")
            return
        
        # 添加知识条目
        for item in knowledge_items:
            db_item = KnowledgeItem(
                title=item["title"],
                category=item["category"],
                content=item["content"],
                tags=item["tags"]
            )
            db.add(db_item)
        
        db.commit()
        print(f"成功添加 {len(knowledge_items)} 条知识库内容。")
    
    except Exception as e:
        db.rollback()
        print(f"添加知识库内容失败: {e}")
    
    finally:
        db.close()

if __name__ == "__main__":
    populate_knowledge_base() 