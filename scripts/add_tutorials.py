#!/usr/bin/env python3
"""
教程内容填充脚本
为流体动力学模拟系统添加教程内容
"""

import sys
import os
from sqlalchemy.orm import Session

# 添加项目根目录到Python路径
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.database.database import SessionLocal, engine
from src.models.models import Tutorial, TutorialStep, Base

# 确保数据库表存在
Base.metadata.create_all(bind=engine)

# 涡环碰撞教程
vortex_ring_tutorial = {
    "title": "涡环碰撞模拟教程",
    "description": "本教程将指导您如何设置和分析涡环碰撞模拟，这是一个展示复杂流体动力学现象的经典案例。",
    "difficulty": "中级",
    "steps": [
        {
            "step_number": 1,
            "title": "涡环的基本概念",
            "content": """
# 涡环的基本概念

涡环是流体力学中一种重要的涡旋结构，具有环状形态，其中流体绕环形轴线旋转。

## 涡环的特性

1. **结构特点**：
   - 环状涡核，内部具有涡度
   - 涡核周围的流体被诱导运动
   - 整体呈环形或环状结构

2. **运动特性**：
   - 涡环沿其轴线方向自推进
   - 速度与环半径和涡度强度有关
   - 在无粘性流体中可以长时间保持稳定

3. **物理意义**：
   - 涡环是涡量守恒的体现
   - 代表了流体中动量和能量的传递机制
   - 在许多自然现象和工程应用中扮演重要角色

## 现实生活中的涡环

- 烟圈是最常见的涡环实例
- 海豚和鲸鱼吐出的水泡形成涡环
- 火箭发射和爆炸产生的烟云中常见涡环结构
- 大气中的涡旋和海洋中的环流

在本教程中，我们将模拟两个涡环相撞的过程，观察它们的相互作用和变形。
            """
        },
        {
            "step_number": 2,
            "title": "设置模拟参数",
            "content": """
# 设置涡环碰撞模拟

要模拟涡环碰撞，我们需要设置两个相向运动的涡环，并观察它们的相互作用。

## 创建模拟会话

1. 首先，在系统中创建一个新的模拟会话：
   - 点击"创建新会话"按钮
   - 输入会话名称，如"涡环碰撞实验"
   - 选择合适的网格尺寸（建议至少128x128x128）
   - 点击"创建"按钮确认

2. 在预设场景列表中找到"涡环碰撞"选项：
   - 调整"涡环强度"参数（默认值为1.0）
     - 较大的值会产生更强的涡环，相互作用更剧烈
     - 较小的值会产生较弱的涡环，相互作用更温和
   
   - 调整"流体粘度"参数（默认值为0.001）
     - 较低的粘度会使涡环结构保持更长时间
     - 较高的粘度会导致涡环更快消散

3. 点击"应用"按钮设置模拟场景

## 参数说明

- **网格尺寸**：决定模拟的空间分辨率
- **涡环半径**：涡环的大小
- **涡环厚度**：涡核的厚度
- **涡环强度**：涡环的旋转强度
- **涡环位置**：两个涡环的初始位置

这些参数已经设置了合理的默认值，但您可以根据需要进行调整。
            """
        },
        {
            "step_number": 3,
            "title": "运行模拟和观察结果",
            "content": """
# 运行涡环碰撞模拟

设置好参数后，我们可以开始运行模拟并观察涡环碰撞的动态过程。

## 启动模拟

1. 点击"开始模拟"按钮启动计算
2. 您可以通过以下控制按钮管理模拟过程：
   - **暂停**：临时停止模拟计算
   - **继续**：恢复已暂停的模拟
   - **停止**：完全终止模拟
   - **步进**：手动推进一个时间步长

## 观察涡环碰撞过程

在模拟运行过程中，您将观察到以下现象：

1. **初始阶段**（0-50步）：
   - 两个涡环相向运动
   - 涡环保持其环状结构
   - 涡环周围的流体被诱导运动

2. **碰撞阶段**（50-100步）：
   - 涡环开始相互作用
   - 涡环形状发生变形
   - 涡核之间产生强烈的流体交换

3. **后碰撞阶段**（100步以后）：
   - 涡环结构发生显著变化
   - 可能形成更小的次级涡环
   - 涡度逐渐扩散和消散

## 可视化技巧

为了更好地观察涡环碰撞过程，建议尝试以下可视化方法：

1. **涡量等值面**：
   - 设置适当的阈值（建议在0.1-0.5之间）
   - 使用不同颜色区分正负涡量

2. **速度矢量场**：
   - 在关键区域显示速度矢量
   - 观察流体的运动方向和大小

3. **切片视图**：
   - 在不同平面上查看速度或涡量分布
   - 特别关注涡环相交区域

4. **粒子追踪**：
   - 释放示踪粒子观察流体运动
   - 可以直观显示涡环的旋转和相互作用
            """
        },
        {
            "step_number": 4,
            "title": "结果分析与物理解释",
            "content": """
# 涡环碰撞结果分析

完成模拟后，我们需要分析结果并理解其中的物理现象。

## 关键物理现象

1. **涡环拉伸**：
   - 当两个涡环接近时，它们相互诱导，导致环形结构拉伸
   - 根据涡量守恒，拉伸会增强涡度
   - 这导致涡核变细但强度增加

2. **涡环重连**：
   - 在碰撞过程中，涡核可能发生拓扑重连
   - 原始涡环的涡线断开并重新连接
   - 形成新的涡环结构，通常垂直于原始平面

3. **能量级联**：
   - 大尺度涡环结构分解为更小尺度的涡旋
   - 能量从大尺度传递到小尺度
   - 最终在最小尺度通过粘性耗散为热能

4. **涡度扩散**：
   - 由于流体粘性，涡度逐渐扩散
   - 涡核变得更宽但强度减弱
   - 最终导致涡环结构消失

## 定量分析

使用系统的分析工具，您可以进行以下定量分析：

1. **动能演化**：
   - 追踪系统总动能随时间的变化
   - 观察碰撞前后的能量转换
   - 分析能量耗散率

2. **涡量统计**：
   - 计算总涡量和涡量平方（散度）
   - 分析涡量分布的变化
   - 识别涡量集中区域

3. **频谱分析**：
   - 对速度场进行傅里叶分析
   - 观察能量在不同波数之间的分布
   - 验证能量级联过程

## 与理论模型比较

将模拟结果与理论预测进行比较：

1. **自相似解**：某些阶段的涡环行为可能表现出自相似性
2. **涡量动力学**：验证Helmholtz涡量定理的应用
3. **能量谱**：检验是否符合Kolmogorov -5/3能量谱律

通过这些分析，您可以深入理解涡环碰撞这一复杂流体动力学现象的本质。
            """
        },
        {
            "step_number": 5,
            "title": "参数研究与进阶实验",
            "content": """
# 参数研究与进阶实验

掌握基本的涡环碰撞模拟后，您可以通过改变参数进行更深入的研究。

## 参数敏感性研究

尝试系统地改变以下参数，观察其对涡环碰撞的影响：

1. **雷诺数变化**：
   - 通过调整粘度改变雷诺数
   - 低雷诺数：涡环快速扩散，相互作用减弱
   - 高雷诺数：涡环结构稳定，相互作用复杂

2. **涡环强度比**：
   - 设置两个涡环具有不同的强度
   - 观察强度不对称对碰撞过程的影响
   - 分析较弱涡环如何被较强涡环变形和吸收

3. **碰撞角度**：
   - 修改涡环的初始位置和方向
   - 研究非正面碰撞的情况
   - 观察掠射碰撞产生的复杂涡结构

4. **涡环尺寸**：
   - 改变涡环半径和厚度
   - 分析尺寸对涡环稳定性和相互作用的影响

## 进阶实验设计

基于基础模拟，您可以设计以下进阶实验：

1. **多涡环相互作用**：
   - 设置三个或更多涡环
   - 研究复杂的多体相互作用
   - 观察可能出现的集体行为

2. **有界域中的涡环**：
   - 在靠近边界的位置释放涡环
   - 研究边界对涡环运动和碰撞的影响
   - 分析涡环与边界层的相互作用

3. **分层流体中的涡环**：
   - 模拟密度分层流体中的涡环运动
   - 观察浮力效应对涡环动力学的影响
   - 研究内波的产生和传播

4. **涡环与剪切流相互作用**：
   - 在背景剪切流中释放涡环
   - 分析剪切如何变形和拉伸涡环
   - 研究涡环在非均匀流场中的演化

通过这些参数研究和进阶实验，您可以获得对涡环动力学更全面和深入的理解，这对流体动力学研究和工程应用都具有重要价值。
            """
        }
    ]
}

def add_tutorials():
    """向数据库添加教程内容"""
    db = SessionLocal()
    try:
        # 检查是否已存在相同标题的教程
        existing_titles = [tutorial.title for tutorial in db.query(Tutorial).all()]
        
        if vortex_ring_tutorial["title"] not in existing_titles:
            # 创建新教程
            db_tutorial = Tutorial(
                title=vortex_ring_tutorial["title"],
                description=vortex_ring_tutorial["description"],
                difficulty=vortex_ring_tutorial["difficulty"]
            )
            db.add(db_tutorial)
            db.flush()  # 获取教程ID
            
            # 添加教程步骤
            for step_data in vortex_ring_tutorial["steps"]:
                db_step = TutorialStep(
                    tutorial_id=db_tutorial.id,
                    step_number=step_data["step_number"],
                    title=step_data["title"],
                    content=step_data["content"]
                )
                db.add(db_step)
            
            db.commit()
            print(f"成功添加教程: {vortex_ring_tutorial['title']}")
        else:
            print(f"教程 '{vortex_ring_tutorial['title']}' 已存在，跳过")
        
    except Exception as e:
        db.rollback()
        print(f"添加教程时出错: {e}")
    finally:
        db.close()

if __name__ == "__main__":
    add_tutorials() 